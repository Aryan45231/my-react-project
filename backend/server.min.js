const express=require("express"),app=express(),fs=require("fs"),path=require("path"),busboy=require("connect-busboy");app.use(busboy());const bodyParser=require("body-parser");app.use(bodyParser.json({limit:"50mb"})),app.use(bodyParser.urlencoded({limit:"50mb",extended:!0})),require("mongoose"),app.use(express.json());const port=process.env.port||5e3,db=require("./db/connection.js"),signin=require("./helpers/signin.js"),signup=require("./helpers/signup.js"),userprofile=require("./helpers/userprofle.js"),multer=require("multer"),storage=multer.diskStorage({destination:(req,file,cb)=>{cb(null,"./upload")},filename:(req,file,cb)=>{cb(null,file.fieldname)}}),upload=multer({storage:storage});app.post("/upload",upload.single("profile"),async(req,res)=>{console.log(req.body.college_id);const rst=await db.Profile.create({bio:req.body.bio,college_id:parseInt(req.body.college_id),profile:{data:fs.readFileSync(path.join(__dirname+"/upload/"+req.file.filename)),contentType:"image/*"}});rst.save(),console.log(rst),res.json({status:res.status})});const blogstorage=multer.diskStorage({destination:(req,file,cb)=>{cb(null,"./upload/blogimage")},filename:(req,file,cb)=>{cb(null,file.fieldname)}}),uploadBlog=multer({storage:blogstorage});app.post("/uploadContent",uploadBlog.single("blogImage"),async(req,res)=>{console.log(req.body.college_id);const ret=await db.Profile.findOne({college_id:`${req.body.college_id}`});if(ret.blog){const status=await db.Profile.updateOne({college_id:`${req.body.college_id}`},{blog:[...ret.blog,{blogTitle:req.body.blogTitle,blogContent:req.body.blogContent,blogImage:{Buffer:fs.readFileSync(path.join(__dirname+"/upload/blogimage/"+req.file.filename)),contentType:"image/*"}}]});conlsole.log(status)}else{const status=await db.Profile.updateOne({college_id:`${req.body.college_id}`},{blog:[{blogTitle:req.body.blogTitle,blogContent:req.body.blogContent,blogImage:{Buffer:fs.readFileSync(path.join(__dirname+"/upload/blogimage/"+req.file.filename)),contentType:"image/*"}}]});console.log(status)}console.log(ret.bio),res.json({file:req.file})}),app.get("/",(req,res)=>{res.send("ok youa are connected")}),app.post("/signup",signup),app.post("/signin",signin),app.post("/useprofile",userprofile),app.listen(port,()=>console.log(`server is at ${port}`));